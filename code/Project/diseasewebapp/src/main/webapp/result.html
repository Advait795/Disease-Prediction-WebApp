<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/result.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Disease Prediction Result</title>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h2>Test <span>Report</span></h2>
      </div>
      <div class="wrapper">
        <div class="collapsible">
          <input type="checkbox" id="collapsible-head-1" />
          <label for="collapsible-head-1" id="head-Hypertension"></label>
          <div class="collapsible-text" id="result-1"></div>
        </div>
        <div class="collapsible">
          <input type="checkbox" id="collapsible-head-2" />
          <label for="collapsible-head-2" id="head-Stroke"></label>
          <div class="collapsible-text" id="result-2"></div>
        </div>
        <div class="collapsible">
          <input type="checkbox" id="collapsible-head-3" />
          <label for="collapsible-head-3" id="head-Diabetes"></label>
          <div class="collapsible-text" id="result-3"></div>
        </div>
      </div>
    </div>

    <script>
      function clearUrl() {
        const url = new URL(window.location.href);
        url.search = "";
        window.history.replaceState(null, "", url);
      }

      window.onload = function () {
        const url = new URLSearchParams(window.location.search);
        const predictedClasses = JSON.parse(
          decodeURIComponent(url.get("predictedClasses"))
        );
        console.log(predictedClasses);

        const featuresPred = JSON.parse(
          decodeURIComponent(url.get("featuresPred"))
        );
        console.log(featuresPred);

        const featuresInput = JSON.parse(
          decodeURIComponent(url.get("featureInput"))
        );
        console.log(featuresInput);

        const hypertension_features = featuresInput.Hypertension;
        //  {
        //   Age: 1,
        //   Sex: 2,
        //   Chest_Pain: 3,
        //   Trest_BPS: 4,
        //   Cholesterol: 5,
        //   Fasting_Blood_Sugar: 6,
        //   Rest_ECG: 7,
        //   Thalach: 8,
        //   Exercise_induced_Angina: 9,
        //   Oldpeak: 10,
        //   ST_Segment_Slope: 11,
        //   Cardiac_Arrhythmia: 12,
        //   Thalassemia: 13,
        // };

        stroke_features = featuresInput.Stroke;
        // {
        //   Sex: 1,
        //   Age: 2,
        //   Hypertension: 3,
        //   Heart_Disease: 4,
        //   Marital_Status: 5,
        //   Work_Stress_Level: 6,
        //   Residence_Status: 7,
        //   Average_Sugar: 8,
        //   Body_Mass_Index: 9,
        //   Smoking: 10,
        // };

        diabetes_features = featuresInput.Diabetes;
        // {
        //   Sex: 1,
        //   Age: 2,
        //   Hypertension: 3,
        //   Heart_Disease: 4,
        //   Smoking_History: 5,
        //   Body_Mass_Index: 6,
        //   Hemoglobin_A1C: 7,
        //   Average_Sugar: 8,
        // };

        const diseases = Object.keys(predictedClasses);

        diseases.forEach((disease, index) => {
          const prediction = predictedClasses[disease];
          const featureData = featuresPred[disease];

          let mappingKey = {};

          if (disease == "Hypertension") {
            for (let key in hypertension_features) {
              value = hypertension_features[key];

              if (featureData[value] !== undefined) {
                mappingKey[key] = featureData[value];
              }
            }
          } else if (disease == "Stroke") {
            for (let key in stroke_features) {
              value = stroke_features[key];

              if (featureData[value] !== undefined) {
                mappingKey[key] = featureData[value];
              }
            }
          } else {
            for (let key in diabetes_features) {
              value = diabetes_features[key];

              if (featureData[value] !== undefined) {
                mappingKey[key] = featureData[value];
              }
            }
          }

          const collapsibleText = document.getElementById(
            `result-${index + 1}`
          );

          const header = document.getElementById(`head-${disease}`);

          header.innerHTML = `${disease} Report : (${prediction}%)`;

          collapsibleText.innerHTML = `<h2>${
            disease.charAt(0).toUpperCase() + disease.slice(1)
          }</h2>
                    <div id="reportBtn-div">
                        <h3>Predicted possibility: ${prediction}%</h3>
                        <button onclick="analyzeReport('${disease}')">Analyze Report</button>
                    </div>

                    <div class="chart-container">
                        <canvas class="chart" id="polar-area-${
                          index + 1
                        }"></canvas>
                        <canvas class="chart" id="bar-chart-${
                          index + 1
                        }"></canvas>
                    </div>`;

          const labels = Object.keys(mappingKey).map(
            (key) => `${key}: ${Math.round(mappingKey[key])}%`
          );
          const data = Object.values(mappingKey);
          const backgroundColor = generateColor(labels.length);
          const borderColor = generateColor(labels.length);

          const polarData = {
            labels: labels,
            datasets: [
              {
                label: "Systoms Probablity",
                data: data,
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 1,
              },
            ],
          };

          let polarCtx = document
            .getElementById(`polar-area-${index + 1}`)
            .getContext("2d");
          new Chart(polarCtx, {
            type: "polarArea",
            data: polarData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                r: {
                  beginAtZero: true,
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";

                      if (label) {
                        label += ": ";
                      }
                      if (context.parsed.y !== null) {
                        label += Math.round(context.raw) + "%";
                      }
                      return label;
                    },
                  },
                },
              },
            },
          });

          let barCtx = document
            .getElementById(`bar-chart-${index + 1}`)
            .getContext("2d");
          new Chart(barCtx, {
            type: "bar",
            data: polarData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";

                      if (label) {
                        label += ": ";
                      }
                      if (context.parsed.y !== null) {
                        label += Math.round(context.raw) + "%";
                      }
                      return label;
                    },
                  },
                },
              },
            },
          });
        });
      };

      function analyzeReport(disease) {
        const url = new URLSearchParams(window.location.search);
        const predictedClasses = JSON.parse(
          decodeURIComponent(url.get("predictedClasses"))
        );
        const featuresPred = JSON.parse(
          decodeURIComponent(url.get("featuresPred"))
        );
        const totalExamples = JSON.parse(
          decodeURIComponent(url.get("totalCount"))
        );
        const classCountOne = JSON.parse(
          decodeURIComponent(url.get("ClassCountOne"))
        );

        const FeatureCounts = JSON.parse(
          decodeURIComponent(url.get("featureCounts"))
        );

        const FeatureInput = JSON.parse(
          decodeURIComponent(url.get("featureInput"))
        );

        // console.log(FeatureCounts);

        const diseasePrediction = JSON.stringify({
          [disease]: predictedClasses[disease],
        });

        const diseaseFeatureCounts = JSON.stringify({
          [disease]: FeatureCounts[disease],
        });

        const diseaseFeatureInput = JSON.stringify({
          [disease]: FeatureInput[disease],
        });

        const diseaseFeatures = JSON.stringify(featuresPred[disease]);
        const diseaseTotalCount = JSON.stringify(totalExamples[disease]);
        const diseaseClassCount = JSON.stringify(classCountOne[disease]);

        window.location.href = `report.html?disease=${encodeURIComponent(
          disease
        )}&prediction=${encodeURIComponent(diseasePrediction)}
        &features=${encodeURIComponent(diseaseFeatures)}
        &totalExamples=${encodeURIComponent(diseaseTotalCount)}
        &classCountOne=${encodeURIComponent(diseaseClassCount)}
        &featureCounts=${encodeURIComponent(diseaseFeatureCounts)}
        &featureInput=${encodeURIComponent(diseaseFeatureInput)}`;
      }

      function generateColor(count) {
        const colors = [
          "rgba(255, 99, 132, 0.6)",
          "rgba(54, 162, 235, 0.6)",
          "rgba(255, 206, 86, 0.6)",
          "rgba(75, 192, 192, 0.6)",
          "rgba(153, 102, 255, 0.6)",
          "rgba(255, 159, 64, 0.6)",
          "rgba(255, 99, 132, 0.6)",
          "rgba(54, 162, 235, 0.6)",
          "rgba(255, 206, 86, 0.6)",
          "rgba(75, 192, 192, 0.6)",
          "rgba(153, 102, 255, 0.6)",
          "rgba(255, 159, 64, 0.6)",
          "rgba(54, 162, 235, 0.6)",
        ];
        return colors.slice(0, count);
      }
    </script>
  </body>
</html>
